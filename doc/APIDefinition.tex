\documentclass[a4paper,10pt]{article}
\usepackage[utf8]{inputenc}

\title{PMES API Definition}
\author{Sandra Corella - Workflows and distributed computing}
\date{Draft - December 2016}

\usepackage{natbib}
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage{multirow}
\usepackage{listings}
\usepackage{color}
 
\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}
 
\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2
}
 
\lstset{style=mystyle}

\begin{document}

\maketitle

\section{Introduction}
Dashboard is on http://192.168.122.12:3000/
PMES Service is on http://192.168.122.12:8080/
\section{API Definition}

\begin{enumerate}
    \item \textbf{createActivity}: Submits a list of jobs to the PMES service.
    \item \textbf{getActivityStatus}: Retrieves the JobStatus object of a set of submitted jobs.
    \item \textbf{getActivityReport}: Gets the activity documents of a set of jobs giving the: JSDLs, jobs status, execution progress, elapsed time and error messages.
    \item \textbf{terminateActivity}: Terminates a set of submitted jobs.
    \item \textbf{getSystemStatus}: Provides information about the resources consuption of the system.
\end{enumerate}

\begin{table}[h!]
    \centering
    \resizebox{1.3\textwidth}{!} {
    \begin{tabular}{l|l|l|l}
        Method & Name & Input & Return \\\hline
        POST & createActivity & \texttt{ArrayList<JobDefinition> jobDef} &  \texttt{ArrayList<String> jobIds} \\
        POST & getActivityStatus & \texttt{ArrayList<String> jobids} &  \texttt{ArrayList<JobStatus> jobStatus} \\
        POST & getActivityReport & \texttt{ArrayList<String> jobids} &  \texttt{ArrayList<JobReport> jobReports} \\
        POST & terminateActivity & \texttt{ArrayList<String> jobIds} &  \texttt{ArrayList<String> terminateMessages} \\
        GET & getSystemStatus & - &  \texttt{SystemStatus} \\
    \end{tabular}}
    \caption{PMES API specification}
    \label{tab:api}
\end{table}

\section{Types}
\subsection{Main Types}
\begin{itemize}
    \item JobDefinition:
\begin{tabular}{|c|c|}
    \hline
    \multicolumn{2}{ |c| }{JobDefinition} \\\hline
    Type & name \\\hline
    String & id \\
    String & jobName \\
    App & app \\
    Image & image \\
    User & user \\
    $[$String$]$ & inputPaths \\
    $[$String$]$ & outputPaths \\
    String & mountPath \\
    Integer & wallTime \\
    Integer & numNodes \\
    Integer & cores \\
    Float & memory \\
    Float & disk \\
    \texttt{HashMap<String, String>} & compss\_flags \\
    Integer & initialVMs \\
    Integer & minimumVMs \\
    Integer & maximumVMs \\
    Integer & limitVMs \\\hline
\end{tabular}
    \item JobStatus
\begin{tabular}{|c|}
    \hline
    JobStatus\\\hline
    PENDING\\
    RUNNING\\
    FINISHED\\
    CANCELLED\\
    FAILED\\
    ALL\\\hline
\end{tabular}
    \item JobReport
\begin{tabular}{|c|c|}
    \hline
    \multicolumn{2}{ |c| }{JobReport} \\\hline
    Type & name \\\hline
    JobDefinition & jobDefinition \\
    String & jobOutputMessage \\
    String & jobErrorMessage \\
    JobStatus & jobStatus \\
    String & elapsedTime \\\hline
\end{tabular}
    \item SystemStatus
\begin{tabular}{|c|c|}
    \hline
    \multicolumn{2}{ |c| }{SystemStatus} \\\hline
    Type & name \\\hline
    \texttt{ArrayList<Host>} & cluster\\\hline
\end{tabular}

\end{itemize}

\subsection{Secondary Types}
\begin{itemize}
    \item App:
\begin{tabular}{|c|c|}
    \hline
    \multicolumn{2}{ |c| }{App} \\\hline
    Type & name \\\hline
    String & id \\
    String & name \\
    String & target \\
    String & source \\
    String & type \\
    \texttt{HashMap<String, String>} & args \\\hline
\end{tabular}
    \item Image:
\begin{tabular}{|c|c|}
    \hline
    \multicolumn{2}{ |c| }{Image} \\\hline
    Type & name \\\hline
    String & id \\
    String & imageName \\
    String & imageType \\\hline
\end{tabular}
    \item User: 
\begin{tabular}{|c|c|}
    \hline
    \multicolumn{2}{ |c| }{User} \\\hline
    Type & name \\\hline
    String & username \\
    \texttt{HashMap<String, String>} & credentials \\\hline
\end{tabular}

The credentials should have: user.key, user.pem, uid and gid. 
    \item Host: 
\begin{tabular}{|c|c|}
    \hline
    \multicolumn{2}{ |c| }{Host} \\\hline
    Type & name \\\hline
    String & name \\
    Integer & usedCores \\
    Integer & totalCores \\
    Float & usedMemory \\
    Float & totalMemory \\\hline
\end{tabular}

\end{itemize}


\section{Usage example}


\begin{lstlisting}[caption=getSystemStatus]
> curl http://localhost:8080/trunk_war_exploded/pmes/getSystemStatus
{"cluster":[
    {"name":"bsccv14",
     "usedCores":1,
     "totalCores":2400,
     "usedMemory":1.0,
     "totalMemory":9.9195808E7},
    {"name":"bsccv15",
     "usedCores":0,
     "totalCores":2400,
     "usedMemory":0.0,
     "totalMemory":9.9195808E7}
    ]
}
\end{lstlisting}

\begin{lstlisting}[caption=getActivityStatus]
> curl -H 'Content-Type: application/json' 
       -X POST 
       --data '["18045e7f-a670-46fe-a067-3b1a19870bcf"]'
       http://localhost:8080/trunk_war_exploded/pmes/getActivityStatus

["FINISHED"]
\end{lstlisting}

\begin{lstlisting}[caption=terminateActivity]
> curl -H 'Content-Type: application/json'
       -X POST
       --data '["18045e7f-a670-46fe-a067-3b1a19870bcf"]'
       http://localhost:8080/trunk_war_exploded/pmes/terminateActivity

["Job with id 18045e7f-a670-46fe-a067-3b1a19870bcf cannot be cancelled,
  the job has been finished."]
\end{lstlisting}


\begin{lstlisting}[caption=createActivity]
> curl -H 'Content-Type: application/json'
       -X POST
       --data 
       '[{ "jobName": "HelloTest2_584817558cb7550b5e9970b0",
           "wallTime": "5",
           "minimumVMs": "1",
           "maximumVMs": "1",
           "limitVMs": "1",
           "initialVMs": "1",
           "memory": "1",
           "cores": "1",
           "inputPath": "/home/",
           "outputPath": "/home/",
           "numNodes": "1",
           "user": 
              { "username": "scorella",
                "credentials": 
                { "pem": "/home/pmes/certs/scorella_test.pem",
                  "key": "/home/pmes/certs/scorella_test.key" } 
              },
           "img": { "imageName": "uuid_pmescompss_83", "imageType": "small" },
           "app": 
              { "name": "HelloTest2",
                "target": "/home/pmes/testSimple",
                "source": "launch.sh",
                "args": { "val1": "Hola", "val2": "Mundo" } 
              } 
        }]'
     http://localhost:8080/trunk_war_exploded/pmes/createActivity

["31eb1268-b6bc-4be2-9fa9-f8a046b752db"]
\end{lstlisting}

\section{VM building}
The image and the template should have the following permissions: Use and Manage for user, group and other.
\subsection{PMES VM}
Dependencies:
\begin{itemize}

 \item Rocci Client and RVM- \verb|{https://github.com/gwdg/rOCCI-cli; https://rvm.io/rvm/install#explained}|
 \begin{lstlisting}
 apt-get install ruby rubygems ruby-dev
 curl -sSL https://get.rvm.io | bash -s stable
 rvm requirements
 rvm install 1.9.3
 rvm use 1.9.3 --default
 gem install occi-cli
 \end{lstlisting}
 or
 \begin{lstlisting}
  curl -L http://go.egi.eu/fedcloud.ui | /bin/bash -
 \end{lstlisting}

 \item move grid-security certificates to /etc/
 \item tomcat7
 \subitem change user to pmes:
 \begin{verbatim}
     sudo nano /etc/default/tomcat7
     TOMCAT7_USER=pmes, TOMCAT7_GROUP=pmes
 \end{verbatim}

 \subitem change user to pmes 
\texttt{ sudo nano /etc/init.d/tomcat7 } and change $TOMCAT7_USER=tomcat7, TOMCAT7_GROUP=tomcat7$
 \subitem create environment \texttt{sudo nano /usr/share/tomcat7/bin/setenv.sh}
 \begin{verbatim}
  echo "setenv SETENV"
export rvm_bin_path=/home/pmes/.rvm/bin
export IRBRC=/home/pmes/.rvm/rubies/ruby-1.9.3-p551/.irbrc
export MY_RUBY_HOME=/home/pmes/.rvm/rubies/ruby-1.9.3-p551
export GEM_HOME=/home/pmes/.rvm/gems/ruby-1.9.3-p551
export GEM_PATH=/home/pmes/.rvm/gems/ruby-1.9.3-p551:/home/pmes/.rvm/gems/ruby-1.9.3-p551@global
export rvm_path=/home/pmes/.rvm
export rvm_prefix=/home/pmes

export PATH=/home/pmes/.rvm/gems/ruby-1.9.3-p551/bin:/home/pmes/.rvm/gems/ruby-1.9.3-p551@global/bin:/home/pmes/.rvm/rubies/ruby-1.9.3-p551/bin:/home/pmes/bin:/home/pmes/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin:/home/pmes/.rvm/bin

env
echo "setenv sale"

 \end{verbatim}

 
 \end{itemize}
\subsection{Install PMES}
create the log folder /home/pmes/pmes/logs and give permissions to the tomcat7 user:
\begin{verbatim}
 sudo usermod -a -G tomcat7 pmes
 sudo chmod g+w myfolder
\end{verbatim}

\subsection{COMPSs VM}
Template 105 has Ubuntu 14, COMPSs 2.0 and CIFS.\\
Template 104 has Ubuntu 16, COMPSs 2.0 and CIFS.


\end{document}
